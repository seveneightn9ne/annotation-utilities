<html>

<head>
    <title>TLE</title>	
    <link rel="stylesheet" href="http://spyysalo.github.io/conllu.js/css/jquery-ui-redmond.css">
    <link rel="stylesheet" href="http://spyysalo.github.io/conllu.js/css/main.css">
    <link rel="stylesheet" href="http://spyysalo.github.io/conllu.js/css/style-vis.css">
    <link rel="stylesheet" type="text/css" href="searchstyle.css">
    <script src="jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="http://spyysalo.github.io/conllu.js/lib/ext/head.load.min.js"></script>
    <script src="jsfunctions.js"></script>
    <script type="text/javascript">
		function do_search(event) {
			$('#results').empty();
			var query = document.getElementById("search_field").value;
    		var error = document.getElementById("error").value;
    		var corpus = document.getElementById("corpus_list").value;
    		var show_corr = document.getElementById("corr").checked;
    		var hl_err = document.getElementById("hl_err").checked;
    		$('#results').append("<p>Searching for <b>"+query+"</b>...</p>");	
    		var ajax_url = "/search?query="+encodeURIComponent(query)+"&corpus="+corpus+"&error="+error;
			$.get(ajax_url, success=function(response){
				$('#results').empty();
				$('#results').append(format_response(response, show_corr, hl_err));
				Annodoc.activate(Config.bratCollData, documentCollections);
				if(hl_err) {
					console.log("highlighting errors");
					$( ".error" ).css( "backgroundColor", "#F88");
				}
			});
		}
		function checkSubmit(e) {
   			if(e && e.keyCode == 13) {
      			document.getElementById("search_button").click();
   			}
		}

		function format_stats_section(stats) {
			html_string = "<b>Result statistics</b>";
			html_string += '<table id="stats_table">';
			html_string += '<tr><td>Parts of speech</td><td width="20px"></td><td>Relations</td></tr>';
			html_string += '<tr><td>';
			html_string += format_stats_table(stats.pos);
			html_string += '</td><td></td><td>';
			html_string += format_stats_table(stats.rel);
			html_string += '</td></tr></table>';
			return html_string;
		}

		function format_stats_table(stats_object) {
			var html_string = '';
			var stats_array = arrayify_and_sort(percentify(stats_object));
			html_string += '<table>';
			for(var i=0; i<stats_array.length; i++) {
				html_string += '<tr><td>'+stats_array[i].key+'</td><td width="10px"></td><td>'+stats_array[i].value+'%</td></tr>';
			}
			html_string += '</table>';
			return html_string;
		}

		function percentify(number_dict) {
			var total = sum_dict(number_dict);
			var percentified_dict = {};
			for (var item in number_dict) {
				percentified_dict[item] = (Math.round(number_dict[item]/total*1000)/10);
			}
			return percentified_dict;
		}

		function arrayify_and_sort(number_dict) {
			var my_array = [];
			for(var item in number_dict) {
				my_array.push({"key":item, "value":number_dict[item]});
			}
			my_array = my_array.sort(function(a,b) { 
				a.value - b.value;
			});
			return my_array;
		}

		function sum_dict(my_dict) {
			var total = 0;
			for (var item in my_dict) {
    			total += my_dict[item];
			}
			return total;
		}

		function format_response(response, show_corr, hl_err) {

			var max_results = 10000;

			console.log(response.matches.length);
			var html_string = "";
			html_string += '<table width="100%"><tr><td width="50%"">'
			html_string += '<div id="search-results-header">';
			html_string += "<p>You searched for <i>"+response.query.query+"</i> in the "+response.query.corpus+" corpus.</p>";
			html_string += "<p>"+response.matches.length+" matching sentences.</p>";
			html_string += '</div></td><td width="50%">';
			html_string += '<div id="stats">';
			html_string += format_stats_section(response.stats);
			html_string += "</div>";
			html_string += "</td></tr></table>";

			for(var i=0; i<Math.min(response.matches.length, max_results); i++) {
				html_string += '<div class="result">';
				var match_positions = [].concat.apply([], response.matches[i].positions);
				/*for(var j=0; j<response.matches[i].sentence.words.length; j++) {
					if(match_positions.indexOf(j) >= 0) {
						html_string += '<span class="match">' + response.matches[i].sentence.words[j].word + '</span> ';
					} else {
						html_string += response.matches[i].sentence.words[j].word + ' ';
					}
				}*/
				if(response.matches[i].sentence.sent_xml != undefined) {
					html_string += response.matches[i].sentence.sent_xml;
				} else {
					html_string += response.matches[i].sentence.word_sentence;
				}

				var tree_highlights = "";
				for(var j=0; j<match_positions.length; j++) {
					tree_highlights += '# visual-style '+(match_positions[j]+1)+' bgColor:#fff59d';
					if(j<match_positions.length-1) tree_highlights += '\n';
				}
				html_string += wrap_sentence_fulltext(tree_highlights+response.matches[i].sentence.fulltext);
				if(show_corr) {
					html_string += wrap_sentence_fulltext(response.matches[i].sentence.corrected.fulltext);
				}
				html_string += '</div>';
			}
			return html_string;
		}

		function wrap_sentence_fulltext(text) {
			return '<pre><code class="language-conllu">'+text+'\n\n</code></pre>';
		}


		jQuery(document).ready(function() {
		    jQuery('.tabs .tab-links a').on('click', function(e)  {
		    	console.log("clicked tab");
		        var currentAttrValue = jQuery(this).attr('href');
		        console.log(currentAttrValue);
		 
		        // Show/Hide Tabs
		        var activateTab = jQuery(currentAttrValue);
		        console.log(activateTab);
		        activateTab.show();
		        var tabsToHide = activateTab.siblings();
		        console.log(tabsToHide);
		        tabsToHide.hide();
		 
		        // Change/remove current tab to active
		        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
		 
		        e.preventDefault();
		    });
		});
    </script>
</head>

<body>

	<h1>The Treebank of Learner English</h1>

	<div class="tabs">
	    <ul class="tab-links">
	        <li class="active" id="leftmost-tab"><a href="#search">Search</a></li>
	        <li><a href="#about">About</a></li>
	    </ul>
	</div>

	<div class="tab-content">
	    <div id="search" class="tab active">
	    	<table id="search-and-instructions">
	    	<tr><td width="50%">
			<div id="search-box" onKeyDown="return checkSubmit(event)">
				<label for="search">Search:</label>
				<input type="text" id="search_field">
				<label for="corpus">Corpus:</label>
				<select id="corpus_list">
					<option value="esl">ESL</option>
					<option value="eng">English</option>
				</select><br>	  		
				<label for="error">Error type:</label>
				<select id="error">
					<option value=""> </option>
					<option value="AGN">Agreement noun</option>
					<option value="AGV">Agreement verb</option>
					<option value="AGA">Agreement pronoun</option>
					<option value="AGD">Agreement determiner</option>
					<option value="AGQ">Agreement quantifier</option>
					<option value="AS">Argument structure</option>
					<option value="CL">Collocation</option>
					<option value="CE">Compound</option>
					<option value="CD">Countability determiner</option>
					<option value="CN">Countability noun</option>  
					<option value="CQ">Countability quantifier</option>
					<option value="DJ">Derivation adjective</option>
					<option value="DY">Derivation adverb</option>
					<option value="DD">Derivation determiner</option>
					<option value="DN">Derivation noun</option>
					<option value="DT">Derivation preposition</option>
					<option value="DA">Derivation pronoun</option>
					<option value="DQ">Derivation quantifier</option>
					<option value="DV">Derivation verb</option>
					<option value="FJ">Form adjective</option>
					<option value="FY">Form adverb</option>
					<option value="FD">Form determiner</option>
					<option value="FN">Form noun</option>
					<option value="FA">Form pronoun</option>
					<option value="FQ">Form quantifier</option>
					<option value="FV">Form verb</option>
					<option value="IJ">Formation adjective</option>
					<option value="IY">Formation adverb</option>
					<option value="ID">Formation determiner</option>
					<option value="X">Formation negation</option>
					<option value="IN">Formation noun</option>
					<option value="IA">Formation pronoun</option>
					<option value="IQ">Formation quantifier</option>
					<option value="IV">Formation verb</option>  
					<option value="MJ">Missing adjective</option>
					<option value="MY">Missing adverb</option>
					<option value="MC">Missing conjunction</option>
					<option value="MD">Missing determiner</option>
					<option value="MN">Missing noun</option>
					<option value="MT">Missing preposition</option>
					<option value="MA">Missing pronoun</option>
					<option value="MP">Missing punctuation</option>
					<option value="MQ">Missing quantifier</option>
					<option value="MV">Missing verb</option>
					<option value="L">Register</option>
					<option value="RJ">Replace adjective</option>
					<option value="RY">Replace adverb</option>
					<option value="RC">Replace conjunction</option>
					<option value="RD">Replace determiner</option>
					<option value="RN">Replace noun</option>
					<option value="RT">Replace preposition</option>
					<option value="RQ">Replace quantifier</option>
					<option value="RA">Replace pronoun</option>
					<option value="RP">Replace punctuation</option>
					<option value="RV">Replace verb</option>
					<option value="S">Spelling</option>
					<option value="SA">Spelling (American)</option>
					<option value="SX">Spelling confusion</option>
					<option value="TV">Tense verb</option>
					<option value="UJ">Unnecessary adjective</option>
					<option value="UY">Unnecessary adverb</option>
					<option value="UC">Unnecessary conjunction</option>
					<option value="UD">Unnecessary determiner</option>
					<option value="UN">Unnecessary noun</option>
					<option value="UT">Unnecessary preposition</option>
					<option value="UA">Unnecessary pronoun</option>
					<option value="UP">Unneccessary punctuation</option>
					<option value="UQ">Unnecessary quantifier</option>
					<option value="UV">Unnecessary verb</option>			  
					<option value="W">Word order</option>
				</select><br>
				<input type="checkbox" id="corr" value="true"> Show corrected version<br>
				<input type="checkbox" id="hl_err" value="true"> Highlight errors<br>
				<button id="search_button" onclick="do_search()">Search</button>
			</div>
			</td><td>
			<div id="instructions">
				<p><b>Instructions</b></p>
				<p>Search for sequences of words, <a href=http://universaldependencies.org/u/pos/index.html>universal</a>/<a href=https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html>PTB</a> part-of-speech tags and <a href=http://universaldependencies.org/en/dep/index.htmlEnglish>UD relation labels</a>.</p>
				<p>The query engine supports regular expressions when searching for words.</p> 
				<p><b>Examples</b>
					<ul>
						<li>see it <i>matches</i> the string "see it"</li>
						<li>see DET NOUN <i>matches</i> see that show, see the sign, etc.</li>
						<li>\w+ing something <i>matches</i> "seeing something", "seeking something", etc.</li>
	                                        <li>amod NNS<i>matches</i> adjectival modifier followed by a plural noun, such as "best cakes", "bigger halls", etc. </li>
					</ul>
			</div>
			</td></tr></table>
			<div id="results">
			</div>
	    </div>
	 
	    <div id="about" class="tab">
	        Coming soon!
	    </div>

	</div>

</body>

<!-- XXX -->

</article>

</body>

<script type="text/javascript">
	var root = 'http://spyysalo.github.io/conllu.js/'; // filled in by jekyll
	head.js(
		// External libraries
		root + 'lib/ext/jquery.min.js',
		root + 'lib/ext/jquery.svg.min.js',
		root + 'lib/ext/jquery.svgdom.min.js',
		root + 'lib/ext/jquery-ui.min.js',
		root + 'lib/ext/waypoints.min.js',

		// brat helper modules
		root + 'lib/brat/configuration.js',
		/* root + 'lib/brat/util.js', */
		'util.js',
		root + 'lib/brat/annotation_log.js',
		root + 'lib/ext/webfont.js',
		// brat modules
		root + 'lib/brat/dispatcher.js',
		root + 'lib/brat/url_monitor.js',
		root + 'lib/brat/visualizer.js',

		// annotation documentation support
		'http://spyysalo.github.io/annodoc/lib/local/annodoc.js',
		root + 'lib/local/config.js',

		// the conllu.js library itself
		root + 'conllu.js'
	);

	var webFontURLs = [
		root + 'static/fonts/PT_Sans-Caption-Web-Regular.ttf',
		root + 'static/fonts/Liberation_Sans-Regular.ttf'
	];

	/* not used here */
	var documentCollections = {};

	head.ready(function() {
	// performes all embedding and support functions
	Annodoc.activate(Config.bratCollData, documentCollections);
	});
</script>



</html>
